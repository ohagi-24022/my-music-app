<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Otoba</title>
    <style>
        /* --- ÂÖ®‰ΩìË®≠ÂÆö --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; background-color: #111; margin: 0; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        
        .app-container { width: 100%; height: 100%; max-width: 1400px; background-color: #f0f0f0; display: flex; flex-direction: row; overflow: hidden; }
        
        /* --- ÂãïÁîª„Çª„ÇØ„Ç∑„Éß„É≥ --- */
        .video-section { flex: 2; background-color: #000; display: flex; flex-direction: column; position: relative; justify-content: center; }
        #player { width: 100%; height: 100%; }
        
        /* ÂºæÂπï„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        #comment-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 20; }
        .flowing-text { position: absolute; white-space: nowrap; color: white; font-weight: bold; text-shadow: 2px 2px 0 #000; font-size: 24px; will-change: transform; }

        /* --- „ÉÅ„É£„ÉÉ„Éà„Çª„ÇØ„Ç∑„Éß„É≥ --- */
        .chat-section { flex: 1; min-width: 320px; display: flex; flex-direction: column; background-color: #7296F3; border-left: 1px solid #333; position: relative; }

        #favorites-area { background: #5b78c7; padding: 8px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; }
        .fav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; margin-right: 5px; cursor: pointer; }

        /* „Çπ„ÇØ„É≠„Éº„É´„Ç®„É™„Ç¢ */
        #chat-area { 
            flex-grow: 1; 
            padding: 15px; 
            overflow-y: auto; 
            background-color: #8fb6eb; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            -webkit-overflow-scrolling: touch; 
        }
        
        /* „É°„ÉÉ„Çª„Éº„Ç∏ */
        .message { 
            flex-shrink: 0; 
            max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; background-color: #fff; align-self: flex-start; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        .message.system { align-self: center; background-color: rgba(255,255,255,0.4); color: #fff; padding: 4px 10px; font-size: 11px; }

        /* Ê§úÁ¥¢ÁµêÊûú„Ç´„Éº„Éâ */
        .search-result-card { 
            flex-shrink: 0; 
            background: white; border-radius: 8px; overflow: hidden; width: 90%; align-self: flex-end; margin-bottom: 5px; display: flex; height: 80px; 
        }
        .card-img { width: 100px; height: 100%; object-fit: cover; cursor: pointer; }
        .card-body { padding: 8px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 12px; font-weight: bold; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .card-btn { background: #1DB446; color: white; border: none; border-radius: 4px; font-size: 11px; padding: 4px; cursor: pointer; }
        /* „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆöÁî®„Éú„Çø„É≥„ÅÆËâ≤ */
        .card-btn.default-mode { background: #E04F5F; }

        .input-area { background: #fff; padding: 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; flex-shrink: 0; }
        input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 16px; }
        button.send-btn { padding: 0 20px; border-radius: 20px; background-color: #2d9bf0; color: white; border: none; font-weight: bold; cursor: pointer; white-space: nowrap;}

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 100; flex-direction: column; color: white; }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .video-section { height: 35vh; flex: none; }
            .chat-section { flex: 1; min-width: 0; border-left: none; }
            #player { position: absolute; top:0; left: 0; }
        }
    </style>
</head>
<body>
    <div id="overlay">
        <h2>Otoba</h2>
        <button id="start-btn" style="padding:15px 40px; font-size:1.2rem; background:#1DB446; border:none; color:white; border-radius:30px;">Start</button>
    </div>

    <div class="app-container">
        <div class="video-section">
            <div id="player"></div>
            <div id="comment-layer"></div>
        </div>
        
        <div class="chat-section">
            <div id="favorites-area"></div>
            <div id="chat-area"></div>
            <div class="input-area">
                <input type="text" id="message-input" placeholder="Ê§úÁ¥¢, #„Ç≥„É°„É≥„Éà, default..." autocomplete="off">
                <button class="send-btn" onclick="sendChat()">ÈÄÅ‰ø°</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // ‚òÖ„ÅäÊ∞ó„Å´ÂÖ•„Çä„É™„Çπ„Éà („Éì„Éá„Ç™„Å®„Éó„É¨„Ç§„É™„Çπ„Éà„ÅÆÊ∑∑Âêà‰æã)
        const favorites = [
            { id: "AOfaWrBwo7I", label: "„Å≤„ÇÖ„Çã„Çä„Çâ„Å±„Å£„Å±", type: "video" },
            { id: "P_CSdxSGfaA", label: "„Ç¢„É≥„Éé„Ç¶„É≥„Éû„Ç∂„Éº„Ç∞„Éº„Çπ", type: "video" },
            { id: "nIWZfhpnq6M", label: "Ê°úÊó•Âíå„Å®„Çø„Ç§„É†„Éû„Ç∑„É≥", type: "video" },
            { id: "0Y8e0LJf0i0", label: "„É™„Éô„É™„Ç™„É≥", type: "video" },
            { id: "PL8yi53amb2is2sQGNGRabKnGC1E-kmVl6", label: "ado", type: "playlist"}
        ];

        const socket = io();
        let player;
        let queue = [];
        let isPlayingUserContent = false;
        
        // ‚òÖÈáçË¶Å: „Éá„Éï„Ç©„É´„ÉàBGM„ÅÆ„Äå‰ªä„ÅÆÂÜçÁîü‰ΩçÁΩÆ„Äç„ÇíË®òÊÜ∂„Åô„ÇãÂ§âÊï∞
        let savedPlaylistIndex = 0;

        // ÂàùÊúü„Éá„Éï„Ç©„É´„ÉàÂÄ§
        let currentDefault = { id: "7Q3BGAPAGQY", type: "video" };

        // --- Socket„Ç§„Éô„É≥„ÉàÂèó‰ø° ---

        socket.on('init-state', (data) => {
            if(data.defaultData) currentDefault = data.defaultData;
        });

        socket.on('update-default', (data) => {
            console.log("Update Default:", data);
            
            // ID„ÅåÂ§â„Çè„Å£„Åü„ÇâÂÜçÁîü‰ΩçÁΩÆ„ÅØ„É™„Çª„ÉÉ„Éà
            if (currentDefault.id !== data.id) {
                savedPlaylistIndex = 0;
            }

            currentDefault = data;

            // „É™„ÇØ„Ç®„Çπ„ÉàÊõ≤„ÅÆÂÜçÁîü‰∏≠„Åß„Å™„Åë„Çå„Å∞„ÄÅÂç≥Â∫ß„Å´Âàá„ÇäÊõø„Åà
            if (!isPlayingUserContent && player) {
                player.stopVideo(); // „Éê„Ç∞Èò≤Ê≠¢„ÅÆ„Åü„ÇÅ„ÅÆÂÅúÊ≠¢
                setTimeout(() => {
                    playDefaultBGM();
                }, 100);
            }
        });

        socket.on('chat-message', (msg) => {
            addMessageToScreen(msg);
            const videoId = extractYouTubeId(msg);
            const lowerMsg = msg.toLowerCase();

            // ‚òÖ„Çπ„Ç≠„ÉÉ„ÉóÊ©üËÉΩ: ‰Ωï„Åå„Å™„Çì„Åß„ÇÇÊ¨°„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„Å∏
            if (lowerMsg === "skip" || msg === "„Çπ„Ç≠„ÉÉ„Éó") {
                playNext();
                return;
            }

            // ‚òÖ„Éç„ÇØ„Çπ„ÉàÊ©üËÉΩ: Áä∂Ê≥Å„Å´„Çà„Å£„Å¶ÂàÜÂ≤ê
            if (lowerMsg === "next" || msg === "„Éç„ÇØ„Çπ„Éà") {
                if (isPlayingUserContent) {
                    // „É™„ÇØ„Ç®„Çπ„ÉàÂÜçÁîü‰∏≠„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó„Å®Âêå„Åò
                    playNext();
                } else {
                    // „Éá„Éï„Ç©„É´„ÉàÂÜçÁîü‰∏≠„Å™„Çâ„ÄÅ„Éó„É¨„Ç§„É™„Çπ„Éà„ÅÆÊ¨°„ÅÆÊõ≤„Å∏
                    if (player && typeof player.nextVideo === 'function') {
                        player.nextVideo();
                    }
                }
                return;
            }

            if (videoId) queueVideo(videoId);
        });

        socket.on('add-queue', (data) => {
            addSystemMessage(`üéµ ${data.source}: ${data.title}`);
            queueVideo(data.videoId);
        });

        socket.on('search-results', (items) => {
            addSystemMessage("üîç Ê§úÁ¥¢ÁµêÊûú („Çø„ÉÉ„Éó„Åß‰∫àÁ¥Ñ):");
            renderSearchResults(items, false);
        });

        socket.on('search-results-for-default', (items) => {
            addSystemMessage("üõ†Ô∏è „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„ÇíÈÅ∏Êäû:");
            renderSearchResults(items, true);
        });

        socket.on('flow-comment', (text) => spawnComment(text));

        // --- ÁîªÈù¢Êìç‰ΩúÁ≥ª ---

        function renderSearchResults(items, isDefaultMode) {
            const chatArea = document.getElementById('chat-area');
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'search-result-card';
                
                const btnLabel = isDefaultMode ? "„Éá„Éï„Ç©„É´„Éà„Å´Ë®≠ÂÆö" : "‰∫àÁ¥Ñ„Åô„Çã";
                const btnClass = isDefaultMode ? "card-btn default-mode" : "card-btn";
                // „Çø„Ç§„Éà„É´ÂÜÖ„ÅÆË®òÂè∑ÂØæÁ≠ñ
                const safeTitle = item.snippet.title.replace(/'/g, "\\'");
                const onClickAction = isDefaultMode 
                    ? `selectDefault('${item.id.videoId}', '${safeTitle}')`
                    : `selectVideo('${item.id.videoId}', '${safeTitle}')`;

                card.innerHTML = `
                    <img src="${item.snippet.thumbnails.high.url}" class="card-img" onclick="${onClickAction}">
                    <div class="card-body">
                        <div class="card-title">${item.snippet.title}</div>
                        <button class="${btnClass}" onclick="${onClickAction}">${btnLabel}</button>
                    </div>
                `;
                chatArea.appendChild(card);
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function sendChat() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;
            socket.emit('client-input', text);
            input.value = '';
        }

        // „ÅäÊ∞ó„Å´ÂÖ•„Çä„ÉªÊ§úÁ¥¢ÁµêÊûú„Åã„Çâ„ÅÆÈÅ∏Êäû
        function selectVideo(videoId, title, type = 'video') {
            // typeÊÉÖÂ†±„ÇÇ‰∏ÄÁ∑í„Å´„Çµ„Éº„Éê„Éº„Å∏ÈÄÅ„Çã
            socket.emit('select-video', { videoId, title, type });
        }

        function selectDefault(videoId, title) {
            socket.emit('select-default', { videoId, title });
            addSystemMessage(`üîÑ Ë®≠ÂÆö‰∏≠...`);
        }

        function queueVideo(videoId) {
            queue.push(videoId);
            if (!isPlayingUserContent) playNext();
        }

        // --- „Éó„É¨„Ç§„É§„ÉºÂà∂Âæ° ---

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: currentDefault.id,
                playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            playDefaultBGM();
        });

        function onPlayerStateChange(event) {
            // ‚òÖ„Éá„Éï„Ç©„É´„ÉàÂÜçÁîü‰∏≠„ÄÅÂ∏∏„Å´‰ΩçÁΩÆ„ÇíË®òÈå≤„Åô„Çã („É™„ÇØ„Ç®„Çπ„Éà„Åß‰∏≠Êñ≠„Åï„Çå„ÅüÊôÇ„Å´Êàª„Çã„Åü„ÇÅ)
            if (!isPlayingUserContent && currentDefault.type === 'playlist' && player.getPlaylistIndex) {
                const idx = player.getPlaylistIndex();
                if (idx !== -1) savedPlaylistIndex = idx;
            }

            if (event.data === YT.PlayerState.ENDED) {
                if (isPlayingUserContent) {
                    playNext();
                } else {
                    if (currentDefault.type === 'video') {
                        player.playVideo(); // ÂçòÊõ≤„É´„Éº„Éó
                    } 
                    // „Éó„É¨„Ç§„É™„Çπ„Éà„ÅØAPIÂÅ¥„ÅßËá™ÂãïÈÄ≤Ë°å
                }
            }
        }

        function playNext() {
            // ‚òÖ„É™„ÇØ„Ç®„Çπ„ÉàÊõ≤„Å´Áßª„ÇãÁõ¥Ââç„ÄÅ„ÇÇ„Åó‰ªä„Éó„É¨„Ç§„É™„Çπ„ÉàÂÜçÁîü‰∏≠„Å™„ÇâÂ†¥ÊâÄ„Çí„É°„É¢„Åô„Çã
            if (!isPlayingUserContent && player && currentDefault.type === 'playlist') {
                if(player.getPlaylistIndex) {
                    savedPlaylistIndex = player.getPlaylistIndex();
                    console.log("‰ΩçÁΩÆ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:", savedPlaylistIndex);
                }
            }

            if (queue.length > 0) {
                isPlayingUserContent = true;
                player.setLoop(false);
                player.loadVideoById(queue.shift());
            } else {
                playDefaultBGM();
            }
        }

        function playDefaultBGM() {
            isPlayingUserContent = false;
            
            if (currentDefault.type === 'playlist') {
                console.log("„Éó„É¨„Ç§„É™„Çπ„ÉàÂæ©Â∏∞ ‰ΩçÁΩÆ:", savedPlaylistIndex);
                player.loadPlaylist({
                    list: currentDefault.id,
                    listType: 'playlist',
                    index: savedPlaylistIndex, // ‚òÖ‰øùÂ≠ò„Åó„Åü‰ΩçÁΩÆ„Åã„ÇâÂÜçÈñã
                    startSeconds: 0
                });
                player.setLoop(true);
            } else {
                player.loadVideoById({
                    videoId: currentDefault.id,
                    startSeconds: 0
                });
                player.setLoop(false);
            }
        }

        // --- „Åù„ÅÆ‰ªñ„Éò„É´„Éë„ÉºÈñ¢Êï∞ ---

        function spawnComment(rawText) {
            const layer = document.getElementById('comment-layer');
            const el = document.createElement('div');
            el.className = 'flowing-text';
            let content = rawText.replace(/^#\s*/, '');
            let color = 'white'; let fontSize = '24px'; let positionMode = 'flow';
            const commands = ['red', 'blue', 'green', 'yellow', 'pink', 'big', 'small', 'shita', 'ue'];
            const words = content.split(' ');
            while (words.length > 0 && commands.includes(words[0])) {
                const cmd = words.shift();
                if (cmd === 'red') color = '#ff0000'; if (cmd === 'blue') color = '#00ffff'; if (cmd === 'green') color = '#00ff00';
                if (cmd === 'yellow') color = '#ffff00'; if (cmd === 'pink') color = '#ff00ff'; if (cmd === 'big') fontSize = '36px';
                if (cmd === 'small') fontSize = '16px'; if (cmd === 'shita') positionMode = 'shita'; if (cmd === 'ue') positionMode = 'ue';
            }
            content = words.join(' ');
            el.innerText = content; el.style.color = color; el.style.fontSize = fontSize;
            layer.appendChild(el);
            if (positionMode === 'flow') {
                el.style.top = Math.random() * 80 + '%'; el.style.right = '-100%';
                const anim = el.animate([{ transform: 'translateX(100vw)' }, { transform: 'translateX(-100vw)' }], { duration: 5000 + Math.random() * 2000, easing: 'linear' });
                anim.onfinish = () => el.remove();
            } else if (positionMode === 'shita') {
                el.style.bottom = '10%'; el.style.left = '50%'; el.style.transform = 'translateX(-50%)'; setTimeout(() => el.remove(), 3000);
            } else if (positionMode === 'ue') {
                el.style.top = '10%'; el.style.left = '50%'; el.style.transform = 'translateX(-50%)'; setTimeout(() => el.remove(), 3000);
            }
        }

        function addMessageToScreen(text) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerText = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        function addSystemMessage(text) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = 'message system';
            div.innerText = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        function extractYouTubeId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }
        
        // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥ÁîüÊàê
        const favArea = document.getElementById('favorites-area');
        favorites.forEach(fav => {
            const btn = document.createElement('button');
            btn.className = 'fav-btn'; btn.innerText = fav.label;
            // typeÂºïÊï∞„ÇíËøΩÂä†
            btn.onclick = () => selectVideo(fav.id, fav.label, fav.type);
            favArea.appendChild(btn);
        });

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });
    </script>
</body>
</html>
