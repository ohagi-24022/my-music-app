<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Music Player</title>
    <style>
        /* (å‰å›ã®CSSã¨åŒã˜ã§ã™ãŒã€ã‚«ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³è‰²ã‚’å¤‰ãˆã‚‹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background-color: #111; margin: 0; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        .app-container { width: 100%; height: 100%; max-width: 1400px; background-color: #f0f0f0; display: flex; flex-direction: row; overflow: hidden; }
        
        .video-section { flex: 2; background-color: #000; display: flex; flex-direction: column; position: relative; justify-content: center; }
        #player { width: 100%; height: 100%; }
        #comment-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 20; }
        .flowing-text { position: absolute; white-space: nowrap; color: white; font-weight: bold; text-shadow: 2px 2px 0 #000; font-size: 24px; will-change: transform; }

        .chat-section { flex: 1; min-width: 320px; display: flex; flex-direction: column; background-color: #7296F3; border-left: 1px solid #333; position: relative; }
        #favorites-area { background: #5b78c7; padding: 8px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; }
        .fav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; margin-right: 5px; cursor: pointer; }

        #chat-area { flex-grow: 1; padding: 15px; overflow-y: auto; background-color: #8fb6eb; display: flex; flex-direction: column; gap: 10px; -webkit-overflow-scrolling: touch; }
        .message { flex-shrink: 0; max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; background-color: #fff; align-self: flex-start; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message.system { align-self: center; background-color: rgba(255,255,255,0.4); color: #fff; padding: 4px 10px; font-size: 11px; }

        .search-result-card { flex-shrink: 0; background: white; border-radius: 8px; overflow: hidden; width: 90%; align-self: flex-end; margin-bottom: 5px; display: flex; height: 80px; }
        .card-img { width: 100px; height: 100%; object-fit: cover; cursor: pointer; }
        .card-body { padding: 8px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 12px; font-weight: bold; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .card-btn { background: #1DB446; color: white; border: none; border-radius: 4px; font-size: 11px; padding: 4px; cursor: pointer; }
        /* â˜…ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šç”¨ãƒœã‚¿ãƒ³ã®è‰²ï¼ˆèµ¤ç³»ï¼‰ */
        .card-btn.default-mode { background: #E04F5F; }

        .input-area { background: #fff; padding: 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; flex-shrink: 0; }
        input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 16px; }
        button.send-btn { padding: 0 20px; border-radius: 20px; background-color: #2d9bf0; color: white; border: none; font-weight: bold; cursor: pointer; white-space: nowrap;}
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 100; flex-direction: column; color: white; }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .video-section { height: 35vh; flex: none; }
            .chat-section { flex: 1; min-width: 0; border-left: none; }
            #player { position: absolute; top:0; left: 0; }
        }
    </style>
</head>
<body>
    <div id="overlay">
        <h2>Music Chat</h2>
        <button id="start-btn" style="padding:15px 40px; font-size:1.2rem; background:#1DB446; border:none; color:white; border-radius:30px;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div class="app-container">
        <div class="video-section">
            <div id="player"></div>
            <div id="comment-layer"></div>
        </div>
        <div class="chat-section">
            <div id="favorites-area"></div>
            <div id="chat-area"></div>
            <div class="input-area">
                <input type="text" id="message-input" placeholder="æ¤œç´¢, #ã‚³ãƒ¡ãƒ³ãƒˆ, default..." autocomplete="off">
                <button class="send-btn" onclick="sendChat()">é€ä¿¡</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const favorites = [
            { id: "jfKfPfyJRdk", label: "Lofi Girl" },
            { id: "5qap5aO4i9A", label: "Lofi HipHop" }
        ];

        const socket = io();
        let player;
        let queue = [];
        let isPlayingUserContent = false;
        let currentDefaultId = "jfKfPfyJRdk";

        socket.on('init-state', (data) => { currentDefaultId = data.defaultId; });

        socket.on('update-default', (data) => {
            currentDefaultId = data.videoId;
            if (!isPlayingUserContent && player) playDefaultBGM();
        });

        socket.on('chat-message', (msg) => {
            addMessageToScreen(msg);
            const videoId = extractYouTubeId(msg);
            if (msg.toLowerCase() === "skip" || msg === "ã‚¹ã‚­ãƒƒãƒ—") {
                if (isPlayingUserContent) playNext();
                return;
            }
            if (videoId) queueVideo(videoId);
        });

        socket.on('add-queue', (data) => {
            addSystemMessage(`ğŸµ ${data.source}: ${data.title}`);
            queueVideo(data.videoId);
        });

        // é€šå¸¸æ¤œç´¢çµæœã®è¡¨ç¤º
        socket.on('search-results', (items) => {
            addSystemMessage("ğŸ” æ¤œç´¢çµæœ (ã‚¿ãƒƒãƒ—ã§äºˆç´„):");
            renderSearchResults(items, false);
        });

        // â˜…ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ›´ç”¨ã®æ¤œç´¢çµæœã®è¡¨ç¤º
        socket.on('search-results-for-default', (items) => {
            addSystemMessage("ğŸ› ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’é¸æŠ:");
            renderSearchResults(items, true); // true = defaultMode
        });

        socket.on('flow-comment', (text) => spawnComment(text));

        // æ¤œç´¢çµæœã®ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚‹é–¢æ•°ï¼ˆå…±é€šåŒ–ï¼‰
        function renderSearchResults(items, isDefaultMode) {
            const chatArea = document.getElementById('chat-area');
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'search-result-card';
                
                const btnLabel = isDefaultMode ? "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š" : "äºˆç´„ã™ã‚‹";
                const btnClass = isDefaultMode ? "card-btn default-mode" : "card-btn";
                // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œã‚’åˆ‡ã‚Šæ›¿ãˆ
                const onClickAction = isDefaultMode 
                    ? `selectDefault('${item.id.videoId}', '${item.snippet.title.replace(/'/g, "\\'")}')`
                    : `selectVideo('${item.id.videoId}', '${item.snippet.title.replace(/'/g, "\\'")}')`;

                card.innerHTML = `
                    <img src="${item.snippet.thumbnails.high.url}" class="card-img" onclick="${onClickAction}">
                    <div class="card-body">
                        <div class="card-title">${item.snippet.title}</div>
                        <button class="${btnClass}" onclick="${onClickAction}">${btnLabel}</button>
                    </div>
                `;
                chatArea.appendChild(card);
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function sendChat() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;
            socket.emit('client-input', text);
            input.value = '';
        }

        function selectVideo(videoId, title) {
            socket.emit('select-video', { videoId, title });
        }

        // â˜… æ–°è¿½åŠ : ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’é¸æŠã—ãŸæ™‚
        function selectDefault(videoId, title) {
            socket.emit('select-default', { videoId, title });
            addSystemMessage(`ğŸ”„ è¨­å®šä¸­...`);
        }

        function queueVideo(videoId) {
            queue.push(videoId);
            if (!isPlayingUserContent) playNext();
        }

        // ... (ä»¥ä¸‹ã€å‰å›ã¨åŒã˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£ã®é–¢æ•°) ...
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: currentDefaultId,
                playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            playDefaultBGM();
        });
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                isPlayingUserContent ? playNext() : player.playVideo();
            }
        }
        function playNext() {
            if (queue.length > 0) {
                isPlayingUserContent = true;
                player.loadVideoById(queue.shift());
            } else {
                playDefaultBGM();
            }
        }
        function playDefaultBGM() {
            isPlayingUserContent = false;
            player.loadVideoById(currentDefaultId);
        }

        // ... (ä»¥ä¸‹ã€ã‚³ãƒ¡ãƒ³ãƒˆæµã—æ©Ÿèƒ½ãªã©å‰å›ã¨åŒã˜) ...
        function spawnComment(rawText) {
            const layer = document.getElementById('comment-layer');
            const el = document.createElement('div');
            el.className = 'flowing-text';
            let content = rawText.replace(/^#\s*/, '');
            let color = 'white'; let fontSize = '24px'; let positionMode = 'flow';
            const commands = ['red', 'blue', 'green', 'yellow', 'pink', 'big', 'small', 'shita', 'ue'];
            const words = content.split(' ');
            while (words.length > 0 && commands.includes(words[0])) {
                const cmd = words.shift();
                if (cmd === 'red') color = '#ff0000'; if (cmd === 'blue') color = '#00ffff'; if (cmd === 'green') color = '#00ff00';
                if (cmd === 'yellow') color = '#ffff00'; if (cmd === 'pink') color = '#ff00ff'; if (cmd === 'big') fontSize = '36px';
                if (cmd === 'small') fontSize = '16px'; if (cmd === 'shita') positionMode = 'shita'; if (cmd === 'ue') positionMode = 'ue';
            }
            content = words.join(' ');
            el.innerText = content; el.style.color = color; el.style.fontSize = fontSize;
            layer.appendChild(el);
            if (positionMode === 'flow') {
                el.style.top = Math.random() * 80 + '%'; el.style.right = '-100%';
                const anim = el.animate([{ transform: 'translateX(100vw)' }, { transform: 'translateX(-100vw)' }], { duration: 5000 + Math.random() * 2000, easing: 'linear' });
                anim.onfinish = () => el.remove();
            } else if (positionMode === 'shita') {
                el.style.bottom = '10%'; el.style.left = '50%'; el.style.transform = 'translateX(-50%)'; setTimeout(() => el.remove(), 3000);
            } else if (positionMode === 'ue') {
                el.style.top = '10%'; el.style.left = '50%'; el.style.transform = 'translateX(-50%)'; setTimeout(() => el.remove(), 3000);
            }
        }

        function addMessageToScreen(text) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerText = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        function addSystemMessage(text) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = 'message system';
            div.innerText = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        function extractYouTubeId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }
        const favArea = document.getElementById('favorites-area');
        favorites.forEach(fav => {
            const btn = document.createElement('button');
            btn.className = 'fav-btn'; btn.innerText = fav.label;
            btn.onclick = () => selectVideo(fav.id, fav.label);
            favArea.appendChild(btn);
        });
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });
    </script>
</body>
</html>
