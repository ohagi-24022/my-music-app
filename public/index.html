<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Music Player</title>
    <style>
        /* --- åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (å‰å›ã¨åŒã˜ãƒ™ãƒ¼ã‚¹) --- */
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #202020; margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .app-container { width: 95%; height: 90vh; max-width: 1400px; background-color: #f0f0f0; display: flex; flex-direction: row; border-radius: 12px; overflow: hidden; }
        
        .video-section { flex: 2; background-color: #000; display: flex; flex-direction: column; position: relative; }
        #player { width: 100%; height: 100%; }
        .status-overlay { position: absolute; top: 0; width: 100%; padding: 10px; background: rgba(0,0,0,0.6); color: white; text-align: center; z-index: 10; }

        .chat-section { flex: 1; min-width: 350px; max-width: 450px; display: flex; flex-direction: column; background-color: #7296F3; border-left: 1px solid #ccc; }

        /* --- ãŠæ°—ã«å…¥ã‚Š(Favorites)ã‚¨ãƒªã‚¢ --- */
        #favorites-area {
            background: #5b78c7;
            padding: 10px;
            overflow-x: auto;
            white-space: nowrap;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .fav-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
            transition: background 0.2s;
        }
        .fav-btn:hover { background: rgba(255,255,255,0.4); }

        /* --- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ --- */
        #chat-area { flex-grow: 1; padding: 20px; overflow-y: auto; background-color: #8fb6eb; display: flex; flex-direction: column; gap: 15px; }
        
        .message { max-width: 85%; padding: 12px 16px; border-radius: 15px; font-size: 15px; background-color: #fff; align-self: flex-start; border-top-left-radius: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message.system { align-self: center; background-color: rgba(255,255,255,0.3); color: #fff; font-size: 12px; padding: 5px 15px; border-radius: 20px; }

        /* --- æ¤œç´¢çµæœã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .search-result-card {
            background: white; border-radius: 10px; overflow: hidden; width: 85%; align-self: flex-end; /* å³å¯„ã› */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-bottom: 5px;
        }
        .card-img { width: 100%; height: 120px; object-fit: cover; cursor: pointer; }
        .card-body { padding: 10px; }
        .card-title { font-size: 13px; font-weight: bold; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-btn { width: 100%; padding: 8px; background: #1DB446; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .card-btn:hover { opacity: 0.9; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area { background: #fff; padding: 20px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        input[type="text"] { flex-grow: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; }
        button.send-btn { padding: 0 25px; border-radius: 25px; border: none; background-color: #2d9bf0; color: white; font-weight: bold; cursor: pointer; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; color: white; z-index: 999; flex-direction: column; }
    </style>
</head>
<body>
    <div id="overlay">
        <h1>Music Chat Player</h1>
        <button id="start-btn" style="padding:15px 40px; font-size:1.2rem; background:#1DB446; border:none; color:white; border-radius:30px; cursor:pointer;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div class="app-container">
        <div class="video-section">
            <div class="status-overlay" id="status-bar">æº–å‚™ä¸­...</div>
            <div id="player"></div>
        </div>
        
        <div class="chat-section">
            <div id="favorites-area">
                </div>

            <div id="chat-area"></div>
            
            <div class="input-area">
                <input type="text" id="message-input" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ ã¾ãŸã¯ URL..." autocomplete="off">
                <button class="send-btn" onclick="sendChat()">é€ä¿¡</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // â˜…ã“ã“ã«ãŠæ°—ã«å…¥ã‚Šã®æ›²ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ï¼
        // id: YouTubeã®å‹•ç”»ID, label: ãƒœã‚¿ãƒ³ã«è¡¨ç¤ºã™ã‚‹åå‰
        const favorites = [
            { id: "jfKfPfyJRdk", label: "Lo-Fi Girl" },
            { id: "m7U-5_N0-lM", label: "ã‚«ãƒ•ã‚§BGM" },
            { id: "ZRtdQ81jPUQ", label: "YOASOBI" },
            { id: "M7lc1UVf-VE", label: "Example" }
        ];

        // --- åˆæœŸåŒ–å‡¦ç† ---
        const socket = io();
        let player;
        let queue = [];
        let isPlayingUserContent = false;
        let currentDefaultId = favorites[0].id; // æœ€åˆã®æ›²ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã™ã‚‹

        // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
        const favArea = document.getElementById('favorites-area');
        favorites.forEach(fav => {
            const btn = document.createElement('button');
            btn.className = 'fav-btn';
            btn.innerText = fav.label;
            btn.onclick = () => selectVideo(fav.id, fav.label);
            favArea.appendChild(btn);
        });

        // --- Socketå—ä¿¡ ---
        socket.on('chat-message', (msg) => {
            addMessageToScreen(msg);
            const videoId = extractYouTubeId(msg);
            
            if (msg === "ã‚¹ã‚­ãƒƒãƒ—" || msg.toLowerCase() === "skip") {
                if (isPlayingUserContent) {
                    addSystemMessage("â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ");
                    playNext();
                }
                return;
            }
            if (videoId) queueVideo(videoId);
        });

        socket.on('add-queue', (data) => {
            // LINEã‚„æ¤œç´¢çµæœã‹ã‚‰ç¢ºå®šã—ãŸæ›²ãŒæ¥ãŸæ™‚
            addSystemMessage(`ğŸµ ${data.source}ã‹ã‚‰äºˆç´„: ${data.title}`);
            queueVideo(data.videoId);
        });

        socket.on('search-results', (items) => {
            // æ¤œç´¢çµæœã‚’è¡¨ç¤º (è‡ªåˆ†ã«ã ã‘è¦‹ãˆã‚‹)
            addSystemMessage("ğŸ” æ¤œç´¢çµæœ (ã‚¯ãƒªãƒƒã‚¯ã§äºˆç´„):");
            const chatArea = document.getElementById('chat-area');
            
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'search-result-card';
                card.innerHTML = `
                    <img src="${item.snippet.thumbnails.high.url}" class="card-img" onclick="selectVideo('${item.id.videoId}', '${item.snippet.title}')">
                    <div class="card-body">
                        <div class="card-title">${item.snippet.title}</div>
                        <button class="card-btn" onclick="selectVideo('${item.id.videoId}', '${item.snippet.title}')">å†ç”Ÿäºˆç´„</button>
                    </div>
                `;
                chatArea.appendChild(card);
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        });

        // --- é€ä¿¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        function sendChat() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;
            
            // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ (URLãªã‚‰å…¨ä½“ã¸ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã‚‰æ¤œç´¢ã¸)
            socket.emit('client-input', text);
            
            // è‡ªåˆ†ã®ç”»é¢ã«ã ã‘è–„ãè¡¨ç¤ºã—ã¦ãŠã
            addSystemMessage(`é€ä¿¡: ${text}`);
            input.value = '';
        }

        // æ¤œç´¢çµæœã‚„ãŠæ°—ã«å…¥ã‚Šã‚’é¸ã‚“ã æ™‚ã®å‡¦ç†
        function selectVideo(videoId, title) {
            socket.emit('select-video', { videoId, title });
        }

        function queueVideo(videoId) {
            queue.push(videoId);
            updateStatus(`äºˆç´„è¿½åŠ  (å¾…ã¡: ${queue.length}æ›²)`);
            if (!isPlayingUserContent) playNext();
        }

        // --- ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼é–¢é€£ (å‰å›ã¨åŒã˜) ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: currentDefaultId,
                playerVars: { 'playsinline': 1, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            playDefaultBGM();
        });
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                isPlayingUserContent ? playNext() : player.playVideo();
            }
        }
        function playNext() {
            if (queue.length > 0) {
                const nextId = queue.shift();
                isPlayingUserContent = true;
                player.loadVideoById(nextId);
                updateStatus(`å†ç”Ÿä¸­: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ`);
            } else {
                playDefaultBGM();
            }
        }
        function playDefaultBGM() {
            isPlayingUserContent = false;
            player.loadVideoById(currentDefaultId);
            updateStatus("å†ç”Ÿä¸­: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBGM");
        }

        // --- UIãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function addMessageToScreen(text) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = 'message';
            
            if (text.includes('youtube.com') || text.includes('youtu.be')) {
                // URLã®å ´åˆã¯ã‚µãƒ ãƒã‚¤ãƒ«ã‚’è¡¨ç¤ºã—ãŸã„ãŒã€ç°¡æ˜“çš„ã«ãƒªãƒ³ã‚¯è¡¨ç¤º
                 div.innerHTML = `ğŸ”— <a href="${text}" target="_blank">å‹•ç”»ãƒªãƒ³ã‚¯</a>`;
            } else {
                div.innerText = text;
            }

            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        function addSystemMessage(text) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = 'message system';
            div.innerText = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        function updateStatus(text) { document.getElementById('status-bar').innerText = text; }
        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });
    </script>
</body>
</html>
