<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Music Player</title>
    <style>
        /* --- å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š --- */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #202020; /* æ˜ ç”»é¤¨ã®ã‚ˆã†ãªæš—ã„èƒŒæ™¯ */
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* ç”»é¢å¤–ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
        }

        /* ã‚¢ãƒ—ãƒªå…¨ä½“ã®æ ï¼šç”»é¢ã„ã£ã±ã„ä½¿ã„ã¤ã¤ä½™ç™½ã‚’æŒãŸã›ã‚‹ */
        .app-container {
            width: 95%;
            height: 90vh;
            max-width: 1400px; /* è¶…ãƒ¯ã‚¤ãƒ‰ç”»é¢ã§ã®åºƒãŒã‚Šã™ãé˜²æ­¢ */
            background-color: #f0f0f0;
            display: flex; /* æ¨ªä¸¦ã³ã«ã™ã‚‹é­”æ³• */
            flex-direction: row; 
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- å·¦å´ï¼šå‹•ç”»ã‚¨ãƒªã‚¢ (ãƒ¡ã‚¤ãƒ³) --- */
        .video-section {
            flex: 2; /* ç”»é¢ã®2/3ã‚’ä½¿ã† */
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        #player {
            width: 100%;
            height: 100%;
        }

        /* å‹•ç”»ä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            text-align: center;
            font-size: 14px;
            z-index: 10;
        }

        /* --- å³å´ï¼šãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ (ã‚µã‚¤ãƒ‰ãƒãƒ¼) --- */
        .chat-section {
            flex: 1; /* ç”»é¢ã®1/3ã‚’ä½¿ã† */
            min-width: 350px; /* ç‹­ããªã‚Šã™ããªã„ã‚ˆã†ã« */
            max-width: 450px;
            display: flex;
            flex-direction: column;
            background-color: #7296F3; /* LINEé¢¨èƒŒæ™¯è‰² */
            border-left: 1px solid #ccc;
        }

        /* ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°è¡¨ç¤ºéƒ¨ */
        #chat-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #8fb6eb;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¹ãå‡ºã—ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 15px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background-color: #fff;
            align-self: flex-start; /* å·¦å¯„ã› */
            border-top-left-radius: 0;
        }

        .message.system {
            align-self: center;
            background-color: rgba(255,255,255,0.3);
            color: #fff;
            font-size: 12px;
            padding: 5px 15px;
            border-radius: 20px;
            border: none;
            box-shadow: none;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area {
            background: #fff;
            padding: 20px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #ddd;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border-radius: 25px;
            border: 1px solid #ddd;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus {
            border-color: #2d9bf0;
        }

        button {
            padding: 0 25px;
            border-radius: 25px;
            border: none;
            background-color: #2d9bf0;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background-color: #1a8ad4; }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼‰ */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center;
            color: white; z-index: 999; flex-direction: column;
        }
        #start-btn {
            margin-top: 20px; padding: 15px 40px; font-size: 1.2rem;
            background: #1DB446; /* LINEã‚«ãƒ©ãƒ¼ */
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œï¼šç”»é¢ãŒç‹­ã„ã¨ãã¯ç¸¦ä¸¦ã³ã«æˆ»ã™ */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: 100vh;
                width: 100%;
                border-radius: 0;
            }
            .video-section { flex: none; height: 35vh; }
            .chat-section { flex: 1; min-width: 0; max-width: none; }
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>Music Chat Player</h1>
        <p>BGMã¨ãƒãƒ£ãƒƒãƒˆã‚’åŒæœŸã—ã¾ã™</p>
        <button id="start-btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div class="app-container">
        <div class="video-section">
            <div class="status-overlay" id="status-bar">æº–å‚™ä¸­...</div>
            <div id="player"></div>
        </div>
        
        <div class="chat-section">
            <div id="chat-area">
                </div>
            
            <div class="input-area">
                <input type="text" id="message-input" placeholder="YouTube URL ã¾ãŸã¯ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." autocomplete="off">
                <button onclick="sendChat()">é€ä¿¡</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const socket = io();
        let player;
        let queue = [];
        let isPlayingUserContent = false;
        let currentDefaultId = "jfKfPfyJRdk"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBGM (Lofi Girl)

        // YouTube APIæº–å‚™
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: currentDefaultId,
                playerVars: { 'playsinline': 1, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            playDefaultBGM();
        });

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å—ä¿¡
        socket.on('chat-message', (msg) => {
            addMessageToScreen(msg);
            
            const videoId = extractYouTubeId(msg);
            
            // ã‚¹ã‚­ãƒƒãƒ—
            if (msg === "ã‚¹ã‚­ãƒƒãƒ—" || msg.toLowerCase() === "skip") {
                if (isPlayingUserContent) {
                    addSystemMessage("â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ");
                    playNext();
                }
                return;
            }

            // URLå—ä¿¡
            if (videoId) {
                queue.push(videoId);
                updateStatus(`äºˆç´„è¿½åŠ  (å¾…ã¡: ${queue.length}æ›²)`);
                if (!isPlayingUserContent) {
                    playNext();
                }
            }
        });

        // é€ä¿¡å‡¦ç†
        function sendChat() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;
            socket.emit('chat-message', text); // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡
            input.value = '';
        }

        // å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (isPlayingUserContent) {
                    playNext();
                } else {
                    player.playVideo(); // ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
                }
            }
        }

        function playNext() {
            if (queue.length > 0) {
                const nextId = queue.shift();
                isPlayingUserContent = true;
                player.loadVideoById(nextId);
                updateStatus(`å†ç”Ÿä¸­: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ`);
            } else {
                playDefaultBGM();
            }
        }

        function playDefaultBGM() {
            isPlayingUserContent = false;
            player.loadVideoById(currentDefaultId);
            updateStatus("å†ç”Ÿä¸­: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBGM");
        }

        // ç”»é¢è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼
        function addMessageToScreen(text) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            
            // URLãŒå«ã¾ã‚Œã‚‹ã‹ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã§è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹
            if (text.includes('youtube.com') || text.includes('youtu.be')) {
                div.className = 'message system';
                div.innerText = `ğŸµ æ›²ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¾ã—ãŸ`;
            } else {
                div.className = 'message';
                div.innerText = text;
            }
            
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function addSystemMessage(text) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = 'message system';
            div.innerText = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function updateStatus(text) {
            document.getElementById('status-bar').innerText = text;
        }

        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Enterã‚­ãƒ¼é€ä¿¡å¯¾å¿œ
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });
    </script>
</body>
</html>
